<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Admin | Gestão Completa</title>

    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icone.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js" defer></script>

    <style>
        :root {
            --primary: #22d3ee; --primary-glow: rgba(34, 211, 238, 0.3);
            --bg-dark: #020617; --bg-card: #0f172a; --text-main: #f1f5f9; --text-dim: #94a3b8;
            --danger: #f43f5e; --success: #10b981; --warning: #fbbf24;
            --border: rgba(255, 255, 255, 0.08); --sidebar-width: 260px;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 30px; border: 1px solid var(--border); width: 100%; max-width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* SIDEBAR & NAV */
        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--bg-card); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; cursor: pointer; }
        
        .sidebar { width: var(--sidebar-width); background: #010409; height: 100vh; position: fixed; border-right: 1px solid var(--border); padding: 30px 20px; display: none; flex-direction: column; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar.active { transform: translateX(0); }
        .sidebar h1 { color: var(--primary); font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 40px; margin-top: 10px; }
        
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 15px; color: var(--text-dim); text-decoration: none; border-radius: 12px; margin-bottom: 8px; transition: 0.2s; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: rgba(34, 211, 238, 0.08); color: var(--primary); }

        /* MAIN CONTENT */
        .main { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 40px; display: none; transition: margin 0.3s; }
        
        /* CARDS & PANELS */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); }
        .stat-card h2 { margin: 8px 0 0; font-size: 2rem; font-weight: 800; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 2fr 1fr; } }

        .panel { background: var(--bg-card); border-radius: 24px; border: 1px solid var(--border); margin-bottom: 30px; overflow: hidden; }
        .panel-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.01); }
        .panel-body { padding: 0; }
        .p-content { padding: 20px; }

        /* TABELA */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 15px 20px; color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.85rem; vertical-align: middle; }

        /* FORMULARIOS */
        input, select { width: 100%; background: #020617; border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: white; margin-bottom: 12px; outline: none; }
        
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-danger { background: rgba(244, 63, 94, 0.15); color: var(--danger); }
        .btn-icon { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: none; cursor: pointer; }

        /* UPLOAD PREVIEW */
        .upload-area { width: 100%; height: 150px; border: 2px dashed var(--border); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; position: relative; overflow: hidden; }
        .upload-area:hover { border-color: var(--primary); background: rgba(34, 211, 238, 0.05); }
        .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; display: none; }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; display: flex; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .main { margin-left: 0; width: 100%; padding: 20px; padding-top: 60px; }
            .mobile-toggle { display: block; }
        }

        /* CUSTOM ALERT */
        #custom-alert { display: none; position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; font-weight: 700; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Banner Item */
        .banner-item { position: relative; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; background: #000; }
        .banner-link-tag { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 0.6rem; padding: 4px; text-align: center; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>

    <div id="custom-alert"><i class="fas fa-check-circle"></i> <span id="alert-msg">Ação realizada!</span></div>

    <div id="login-overlay">
        <div class="login-card">
            <i class="fas fa-user-shield" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="margin-bottom: 10px;">Master Admin</h2>
            <p style="color:var(--text-dim); margin-bottom: 25px; font-size: 0.9rem;">Painel de Controle BarcoApp</p>
            <input type="password" id="admin-pass" placeholder="Senha de Acesso">
            <button class="btn btn-primary" onclick="handleLogin()">ENTRAR</button>
        </div>
    </div>

    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

    <div class="sidebar" id="sidebar">
        <h1><i class="fas fa-ship"></i> ADMIN<span style="color:white">PANEL</span></h1>
        <div class="nav-item active" onclick="showSection('dashboard', this)"><i class="fas fa-chart-pie"></i> Visão Geral</div>
        <div class="nav-item" onclick="showSection('fleet', this)"><i class="fas fa-ship"></i> Frota Base (Outros)</div>
        <div class="nav-item" onclick="showSection('trips', this)"><i class="fas fa-calendar-alt"></i> Viagens Ativas</div>
        <div class="nav-item" onclick="showSection('users', this)"><i class="fas fa-users"></i> Usuários</div>
        <div class="nav-item" onclick="showSection('config', this)"><i class="fas fa-cog"></i> Configurações</div>
        <div style="margin-top: auto;">
            <div class="nav-item" style="color: var(--danger);" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</div>
        </div>
    </div>

    <div class="main" id="main-content">
        
        <div id="sec-dashboard">
            <div class="stats-row">
                <div class="stat-card"><small style="color:var(--primary)">Usuários</small><h2 id="st-users">0</h2></div>
                <div class="stat-card"><small style="color:var(--success)">Barcos Cadastrados</small><h2 id="st-fleet">0</h2></div>
                <div class="stat-card"><small style="color:var(--warning)">Viagens Hoje</small><h2 id="st-trips">0</h2></div>
                <div class="stat-card"><small>Saldo Likes</small><h2 id="st-likes">0</h2></div>
            </div>
            
            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-trophy" style="color:var(--warning)"></i> Top Ranking de Popularidade</h3></div>
                <div class="panel-body p-content" id="ranking-list">Carregando...</div>
            </div>
        </div>

        <div id="sec-fleet" style="display:none;">
            <div class="dashboard-grid">
                <div>
                    <div class="panel">
                        <div class="panel-header"><h3><i class="fas fa-plus-circle"></i> Cadastrar Nova Embarcação</h3></div>
                        <div class="panel-body p-content">
                            <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:15px;">Adicione aqui barcos novos ("Outros") para que apareçam na lista do usuário.</p>
                            
                            <div class="upload-area" onclick="document.getElementById('fleet-file').click()">
                                <i class="fas fa-camera" style="font-size: 2rem; color: var(--text-dim); margin-bottom: 10px;"></i>
                                <span style="font-size: 0.8rem; color: var(--text-dim);">Toque para adicionar foto</span>
                                <img id="fleet-preview" class="preview-img">
                            </div>
                            <input type="file" id="fleet-file" accept="image/*" style="display:none" onchange="processFleetImage(this)">
                            
                            <input type="text" id="fleet-name" placeholder="Nome da Embarcação">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="tel" id="fleet-tel1" placeholder="WhatsApp 1 (DDD+Num)">
                                <input type="tel" id="fleet-tel2" placeholder="WhatsApp 2 (Opcional)">
                            </div>
                            <button class="btn btn-primary" onclick="saveFleetBoat()">CADASTRAR BARCO</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="panel">
                        <div class="panel-header"><h3>Frota Cadastrada</h3></div>
                        <div class="panel-body p-content" id="fleet-list" style="max-height: 500px; overflow-y: auto;">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-trips" style="display:none;">
            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-anchor"></i> Escalas Publicadas pelos Usuários</h3></div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Barco</th><th>Dia</th><th>Rota</th><th>Likes</th><th>Ação</th></tr></thead>
                        <tbody id="trips-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-users" style="display:none;">
            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-users"></i> Usuários do App</h3></div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Nome</th><th>WhatsApp</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody id="users-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-config" style="display:none;">
            <div class="panel">
                <div class="panel-header"><h3>Alerta Global (Aviso no App)</h3></div>
                <div class="panel-body p-content">
                    <input type="text" id="alert-text-config" placeholder="Ex: Manutenção no porto amanhã...">
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="background:var(--success); color:white; flex:1" onclick="setGlobalAlert(true)">ATIVAR</button>
                        <button class="btn" style="background:var(--danger); color:white; flex:1" onclick="setGlobalAlert(false)">DESATIVAR</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3>Carrossel de Banners</h3></div>
                <div class="panel-body p-content">
                    <label style="font-size:0.7rem; color:var(--text-dim); font-weight:700;">IMAGEM DO BANNER (URL)</label>
                    <input type="text" id="banner-url" placeholder="https://exemplo.com/banner.jpg">
                    
                    <label style="font-size:0.7rem; color:var(--text-dim); font-weight:700;">LINK AO CLICAR (OPCIONAL)</label>
                    <input type="text" id="banner-link" placeholder="https://site-patrocinador.com">
                    
                    <button class="btn btn-primary" onclick="addBanner()">ADICIONAR BANNER</button>
                    
                    <div id="banner-list" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // CONFIG FIREBASE
            const firebaseConfig = {
                apiKey: "AIzaSyCSqpD1irHfgXpzAytoRn_VNwImNzuGouE",
                authDomain: "barcoapp01.firebaseapp.com",
                databaseURL: "https://barcoapp01-default-rtdb.firebaseio.com",
                projectId: "barcoapp01",
                storageBucket: "barcoapp01.firebasestorage.app",
                messagingSenderId: "715122174520",
                appId: "1:715122174520:web:da4ae91a6862c129d714cd"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            
            let fleetImgBase64 = "";

            // --- NAVEGAÇÃO ---
            window.toggleSidebar = function() {
                document.getElementById('sidebar').classList.toggle('active');
            }

            window.showSection = function(id, btn) {
                document.querySelectorAll('.main > div').forEach(d => d.style.display = 'none');
                document.getElementById('sec-' + id).style.display = 'block';
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                btn.classList.add('active');
                
                if(window.innerWidth <= 768) toggleSidebar(); 
            }

            window.handleLogin = function() {
                const p = document.getElementById('admin-pass').value;
                if(p === "barco77") { 
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'flex';
                    document.getElementById('main-content').style.display = 'block';
                    firebase.auth().signInAnonymously();
                    initDashboard();
                } else {
                    alert("Senha incorreta");
                }
            }
            
            window.logout = function() { location.reload(); }

            window.showToast = function(msg) {
                const t = document.getElementById('custom-alert');
                document.getElementById('alert-msg').innerText = msg;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            }

            function initDashboard() {
                db.ref().on('value', snap => {
                    const data = snap.val();
                    if(!data) return;

                    updateStats(data);
                    renderFleet(data.barcos_cadastrados);
                    renderTrips(data.barcos);
                    renderUsers(data.usuarios_cadastrados, data.barcos);
                    renderConfig(data.config);
                });
            }

            // --- ESTATISTICAS ---
            function updateStats(data) {
                const users = data.usuarios_cadastrados ? Object.keys(data.usuarios_cadastrados).length : 0;
                const fleet = data.barcos_cadastrados ? Object.keys(data.barcos_cadastrados).length : 0;
                let trips = 0;
                let totalLikes = 0;
                if(data.barcos) {
                    Object.values(data.barcos).forEach(day => {
                        Object.values(day).forEach(t => {
                            trips++;
                            totalLikes += (t.likes || 0) - (t.dislikes || 0);
                        });
                    });
                }
                document.getElementById('st-users').innerText = users;
                document.getElementById('st-fleet').innerText = fleet;
                document.getElementById('st-trips').innerText = trips;
                document.getElementById('st-likes').innerText = totalLikes;
            }

            // --- GESTÃO DE FROTA ---
            window.processFleetImage = function(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const scale = 500 / img.width;
                            canvas.width = 500;
                            canvas.height = img.height * scale;
                            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                            fleetImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
                            const preview = document.getElementById('fleet-preview');
                            preview.src = fleetImgBase64;
                            preview.style.display = 'block';
                        }
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            window.saveFleetBoat = function() {
                const name = document.getElementById('fleet-name').value;
                const t1 = document.getElementById('fleet-tel1').value;
                const t2 = document.getElementById('fleet-tel2').value;
                if(!name || !t1 || !fleetImgBase64) return alert("Preencha Nome, Telefone 1 e Foto");

                const id = Date.now();
                db.ref('barcos_cadastrados/' + id).set({
                    id: id, name: name, tel1: t1, tel2: t2, img: fleetImgBase64
                }).then(() => {
                    showToast("Barco Cadastrado!");
                    document.getElementById('fleet-name').value = "";
                    document.getElementById('fleet-preview').style.display = 'none';
                    fleetImgBase64 = "";
                });
            }

            window.deleteFleet = function(id) {
                if(confirm("Apagar este barco da base?")) db.ref('barcos_cadastrados/' + id).remove();
            }

            function renderFleet(fleet) {
                const list = document.getElementById('fleet-list');
                list.innerHTML = "";
                if(fleet) {
                    Object.values(fleet).forEach(b => {
                        list.innerHTML += `
                        <div style="display:flex; align-items:center; gap:10px; padding:10px; background:rgba(255,255,255,0.03); margin-bottom:8px; border-radius:10px;">
                            <img src="${b.img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                            <div style="flex:1;">
                                <div style="font-weight:700; font-size:0.9rem;">${b.name}</div>
                                <div style="font-size:0.7rem; color:var(--text-dim);">${b.tel1}</div>
                            </div>
                            <button class="btn-icon btn-danger" onclick="deleteFleet('${b.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    });
                }
            }

            // --- VIAGENS ---
            window.deleteTrip = function(day, key) { if(confirm("Apagar viagem?")) db.ref(`barcos/${day}/${key}`).remove(); }

            function renderTrips(barcos) {
                const list = document.getElementById('trips-list');
                list.innerHTML = "";
                if(barcos) {
                    Object.keys(barcos).forEach(day => {
                        Object.entries(barcos[day]).forEach(([k, t]) => {
                            list.innerHTML += `
                            <tr>
                                <td><div style="display:flex; align-items:center; gap:8px;"><img src="${t.img}" style="width:30px; height:30px; border-radius:50%; object-fit:cover"> ${t.name}</div></td>
                                <td>${day}</td>
                                <td>${t.origin} > ${t.destiny}</td>
                                <td><span style="color:var(--success)">+${t.likes||0}</span></td>
                                <td><button class="btn-icon btn-danger" onclick="deleteTrip('${day}','${k}')"><i class="fas fa-trash"></i></button></td>
                            </tr>`;
                        });
                    });
                }
            }

            // --- USUÁRIOS E RANKING ---
            window.deleteUser = function(uid) { if(confirm("Banir usuário?")) db.ref(`usuarios_cadastrados/${uid}`).remove(); }

            function renderUsers(users, barcos) {
                const list = document.getElementById('users-list');
                const rankList = document.getElementById('ranking-list');
                list.innerHTML = "";
                let userScores = [];
                if(users) {
                    Object.entries(users).forEach(([uid, u]) => {
                        let points = 0;
                        if(barcos) {
                            Object.values(barcos).forEach(day => {
                                Object.values(day).forEach(t => {
                                    if(t.registeredBy === u.whatsapp) points += ((t.likes||0) - (t.dislikes||0));
                                });
                            });
                        }
                        userScores.push({name: u.nome, points: points});

                        list.innerHTML += `
                        <tr>
                            <td><b>${u.nome}</b></td>
                            <td>${u.whatsapp}</td>
                            <td><span style="color:${points>=0?'var(--primary)':'var(--danger)'}">${points} Pts</span></td>
                            <td><button class="btn-icon btn-danger" onclick="deleteUser('${uid}')"><i class="fas fa-user-slash"></i></button></td>
                        </tr>`;
                    });
                    userScores.sort((a,b) => b.points - a.points);
                    rankList.innerHTML = userScores.slice(0, 5).map((u, i) => `
                        <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border)">
                            <span>${i+1}º ${u.name}</span>
                            <span style="font-weight:800; color:var(--primary)">${u.points}</span>
                        </div>
                    `).join('');
                }
            }

            // --- CONFIGS & CARROSSEL ---
            window.setGlobalAlert = function(active) {
                const txt = document.getElementById('alert-text-config').value;
                db.ref('config/alerta').set({text: txt, active: active}).then(()=> showToast(active ? "Alerta Ativado" : "Alerta Removido"));
            }

            window.addBanner = function() {
                const url = document.getElementById('banner-url').value;
                const link = document.getElementById('banner-link').value; // PEGA O LINK
                
                if(url) {
                    db.ref('config/carrossel').push({img: url, link: link}).then(()=> {
                        document.getElementById('banner-url').value="";
                        document.getElementById('banner-link').value="";
                        showToast("Banner Adicionado");
                    });
                } else {
                    alert("A imagem é obrigatória!");
                }
            }

            window.delBanner = function(k) { if(confirm("Apagar banner?")) db.ref(`config/carrossel/${k}`).remove(); }

            function renderConfig(cfg) {
                if(cfg && cfg.alerta) document.getElementById('alert-text-config').value = cfg.alerta.text;
                const blist = document.getElementById('banner-list');
                blist.innerHTML = "";
                if(cfg && cfg.carrossel) {
                    Object.entries(cfg.carrossel).forEach(([k, v]) => {
                        // Mostra se tem link ou não
                        const linkTag = v.link ? `<div class="banner-link-tag"><i class="fas fa-link"></i> ${v.link}</div>` : '';
                        
                        blist.innerHTML += `
                        <div class="banner-item">
                            <img src="${v.img}" style="width:100%; display:block;">
                            ${linkTag}
                            <button onclick="delBanner('${k}')" style="position:absolute; top:5px; right:5px; background:rgba(255,0,0,0.8); color:white; border:none; border-radius:4px; width:24px; height:24px; cursor:pointer;">X</button>
                        </div>`;
                    });
                }
            }
        });
    </script>
</body>
</html>
