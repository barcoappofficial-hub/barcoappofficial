<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Admin | Gestão Completa</title>

    <meta name="theme-color" content="#020617">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icone.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #22d3ee; --primary-glow: rgba(34, 211, 238, 0.3);
            --bg-dark: #020617; --bg-card: #0f172a; --text-main: #f1f5f9; --text-dim: #94a3b8;
            --danger: #f43f5e; --success: #10b981; --warning: #fbbf24;
            --border: rgba(255, 255, 255, 0.08); --sidebar-width: 260px;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--bg-card); padding: 40px; border-radius: 30px; border: 1px solid var(--border); width: 100%; max-width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* Navigation */
        .mobile-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--bg-card); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; cursor: pointer; }
        .sidebar { width: var(--sidebar-width); background: #010409; height: 100vh; position: fixed; border-right: 1px solid var(--border); padding: 30px 20px; display: none; flex-direction: column; z-index: 1000; transition: transform 0.3s ease; }
        .sidebar.active { transform: translateX(0); }
        .sidebar h1 { color: var(--primary); font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 40px; margin-top: 10px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 15px; color: var(--text-dim); text-decoration: none; border-radius: 12px; margin-bottom: 8px; transition: 0.2s; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: rgba(34, 211, 238, 0.08); color: var(--primary); }

        /* Main Area */
        .main { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 40px; display: none; transition: margin 0.3s; }
        
        /* Stats & Panels */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 24px; border-radius: 20px; border: 1px solid var(--border); }
        .stat-card h2 { margin: 8px 0 0; font-size: 2rem; font-weight: 800; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }

        .panel { background: var(--bg-card); border-radius: 24px; border: 1px solid var(--border); margin-bottom: 30px; overflow: hidden; display: flex; flex-direction: column; }
        .panel-header { padding: 20px 25px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.01); }
        .panel-header h3 { margin: 0; font-size: 1rem; color: var(--text-main); }
        .p-content { padding: 20px; }

        /* Tables & Lists */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 15px 20px; color: var(--text-dim); font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.85rem; vertical-align: middle; }

        /* Inputs & Buttons */
        input, select { width: 100%; background: #020617; border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: white; margin-bottom: 12px; outline: none; }
        .btn { padding: 12px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: #000; width: 100%; }
        .btn-danger { background: rgba(244, 63, 94, 0.15); color: var(--danger); }
        .btn-icon { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: none; cursor: pointer; }

        /* Upload */
        .upload-area { width: 100%; height: 150px; border: 2px dashed var(--border); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px; position: relative; overflow: hidden; }
        .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; display: none; }

        /* Alerts & Badge */
        #custom-alert { display: none; position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10000; font-weight: 700; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .badge { background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; margin-left: 5px; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 280px; display: flex; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { transform: translateX(0); }
            .main { margin-left: 0; width: 100%; padding: 20px; padding-top: 60px; }
            .mobile-toggle { display: block; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="custom-alert"><i class="fas fa-check-circle"></i> <span id="alert-msg">Ação realizada!</span></div>

    <div id="login-overlay">
        <div class="login-card">
            <i class="fas fa-user-shield" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="margin-bottom: 10px;">Master Admin</h2>
            <input type="password" id="admin-pass" placeholder="Senha de Acesso">
            <button class="btn btn-primary" onclick="handleLogin()">ENTRAR</button>
        </div>
    </div>

    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="sidebar" id="sidebar">
        <h1><i class="fas fa-ship"></i> ADMIN<span style="color:white">PANEL</span></h1>
        <div class="nav-item active" onclick="showSection('dashboard', this)"><i class="fas fa-chart-pie"></i> Visão Geral</div>
        <div class="nav-item" onclick="showSection('fleet', this)"><i class="fas fa-ship"></i> Frota Base</div>
        <div class="nav-item" onclick="showSection('trips', this)"><i class="fas fa-calendar-alt"></i> Viagens Ativas</div>
        <div class="nav-item" onclick="showSection('reports', this)" style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Denúncias <span id="badge-reports" class="badge" style="display:none">0</span></div>
        <div class="nav-item" onclick="showSection('users', this)"><i class="fas fa-users"></i> Usuários</div>
        <div class="nav-item" onclick="showSection('config', this)"><i class="fas fa-cog"></i> Configurações</div>
        <div style="margin-top: auto; color: var(--danger);" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</div>
    </div>

    <div class="main" id="main-content">
        
        <div id="sec-dashboard">
            <div class="stats-row">
                <div class="stat-card"><small style="color:var(--primary)">Usuários</small><h2 id="st-users">0</h2></div>
                <div class="stat-card"><small style="color:var(--success)">Barcos Cadastrados</small><h2 id="st-fleet">0</h2></div>
                <div class="stat-card"><small style="color:var(--warning)">Viagens Hoje</small><h2 id="st-trips">0</h2></div>
                <div class="stat-card" style="border-color:var(--danger)"><small style="color:var(--danger)">Denúncias</small><h2 id="st-reports">0</h2></div>
            </div>
            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-trophy" style="color:var(--warning)"></i> Ranking de Usuários</h3></div>
                <div class="panel-body p-content" id="ranking-list">Carregando...</div>
            </div>
        </div>

        <div id="sec-fleet" style="display:none;">
            <div class="dashboard-grid">
                <div class="panel">
                    <div class="panel-header"><h3><i class="fas fa-plus-circle"></i> Novo Barco (Base)</h3></div>
                    <div class="panel-body p-content">
                        <div class="upload-area" onclick="document.getElementById('fleet-file').click()">
                            <i class="fas fa-camera" style="font-size: 2rem; color: var(--text-dim); margin-bottom: 10px;"></i>
                            <span style="font-size: 0.8rem; color: var(--text-dim);">Toque para foto</span>
                            <img id="fleet-preview" class="preview-img">
                        </div>
                        <input type="file" id="fleet-file" accept="image/*" style="display:none" onchange="processFleetImage(this)">
                        
                        <input type="text" id="fleet-name" placeholder="Nome da Embarcação">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="tel" id="fleet-tel1" placeholder="WhatsApp 1">
                            <input type="tel" id="fleet-tel2" placeholder="WhatsApp 2">
                        </div>
                        <button class="btn btn-primary" onclick="saveFleetBoat()">SALVAR BARCO</button>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header"><h3>Frota Atual</h3></div>
                    <div class="panel-body p-content" style="flex: 1;">
                        <div id="fleet-list" style="max-height: 600px; overflow-y: auto;">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="sec-trips" style="display:none;">
            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-anchor"></i> Escalas Publicadas</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Barco</th><th>Dia</th><th>Rota</th><th>Likes</th><th>Ação</th></tr></thead><tbody id="trips-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="sec-reports" style="display:none;">
            <div class="panel" style="border-color: var(--danger);">
                <div class="panel-header"><h3 style="color:var(--danger)">Denúncias</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Barco</th><th>Motivo</th><th>Denunciante</th><th>Ação</th></tr></thead><tbody id="reports-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="sec-users" style="display:none;">
            <div class="panel">
                <div class="panel-header"><h3>Usuários</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Nome</th><th>WhatsApp</th><th>Pts</th><th>Ação</th></tr></thead><tbody id="users-list"></tbody></table>
                </div>
            </div>
        </div>

        <div id="sec-config" style="display:none;">
            <div class="panel">
                <div class="panel-header"><h3>Alerta Global</h3></div>
                <div class="panel-body p-content">
                    <input type="text" id="alert-text-config" placeholder="Mensagem...">
                    <div style="display:flex; gap:10px;"><button class="btn" style="background:var(--success); color:white; flex:1" onclick="setGlobalAlert(true)">LIGAR</button><button class="btn" style="background:var(--danger); color:white; flex:1" onclick="setGlobalAlert(false)">DESLIGAR</button></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><h3>Banners</h3></div>
                <div class="panel-body p-content">
                    <input type="text" id="banner-url" placeholder="URL da Imagem">
                    <input type="text" id="banner-link" placeholder="Link de Destino">
                    <button class="btn btn-primary" onclick="addBanner()">ADD BANNER</button>
                    <div id="banner-list" style="margin-top:20px; display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr))"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const firebaseConfig = {
                apiKey: "AIzaSyCSqpD1irHfgXpzAytoRn_VNwImNzuGouE",
                authDomain: "barcoapp01.firebaseapp.com",
                databaseURL: "https://barcoapp01-default-rtdb.firebaseio.com",
                projectId: "barcoapp01",
                storageBucket: "barcoapp01.firebasestorage.app",
                messagingSenderId: "715122174520",
                appId: "1:715122174520:web:da4ae91a6862c129d714cd"
            };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            
            let fleetImgBase64 = "";

            window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('active'); }
            window.showSection = function(id, btn) {
                document.querySelectorAll('.main > div').forEach(d => d.style.display = 'none');
                document.getElementById('sec-' + id).style.display = 'block';
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                btn.classList.add('active');
                if(window.innerWidth <= 768) toggleSidebar();
            }

            window.handleLogin = function() {
                if(document.getElementById('admin-pass').value === "barco77") {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'flex';
                    document.getElementById('main-content').style.display = 'block';
                    firebase.auth().signInAnonymously().catch(err => console.error("Auth Error:", err));
                    initDashboard();
                } else alert("Senha errada");
            }
            window.logout = function() { location.reload(); }
            window.showToast = function(msg) {
                const t = document.getElementById('custom-alert');
                document.getElementById('alert-msg').innerText = msg;
                t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
            }

            // FUNÇÃO PRINCIPAL DE LEITURA
            function initDashboard() {
                db.ref().on('value', snap => {
                    const data = snap.val() || {};
                    console.log("DADOS RECEBIDOS:", data); // Debug no Console

                    updateStats(data);
                    renderFleet(data.barcos_cadastrados);
                    renderTrips(data.barcos);
                    renderUsers(data.usuarios_cadastrados, data.barcos);
                    renderReports(data.denuncias);
                    renderConfig(data.config);
                });
            }

            function updateStats(data) {
                const users = data.usuarios_cadastrados ? Object.keys(data.usuarios_cadastrados).length : 0;
                const fleet = data.barcos_cadastrados ? Object.keys(data.barcos_cadastrados).length : 0;
                const reports = data.denuncias ? Object.keys(data.denuncias).length : 0;
                let trips = 0, likes = 0;
                if(data.barcos) Object.values(data.barcos).forEach(d => Object.values(d).forEach(t => { trips++; likes += (t.likes||0); }));
                
                document.getElementById('st-users').innerText = users;
                document.getElementById('st-fleet').innerText = fleet;
                document.getElementById('st-trips').innerText = trips;
                document.getElementById('st-likes').innerText = likes;
                document.getElementById('st-reports').innerText = reports;
                
                const badge = document.getElementById('badge-reports');
                badge.style.display = reports > 0 ? 'inline-block' : 'none';
                badge.innerText = reports;
            }

            // --- RENDERIZADORES BLINDADOS ---

            // 1. Renderizar Frota (Correção Principal)
            function renderFleet(fleet) {
                const list = document.getElementById('fleet-list');
                list.innerHTML = ""; // Limpa
                
                if(!fleet) {
                    list.innerHTML = "<div style='text-align:center; padding:30px; color:#64748b;'>Nenhum barco na base.</div>";
                    return;
                }

                Object.values(fleet).forEach(b => {
                    // Proteção contra dados quebrados
                    const img = b.img || 'icone.png';
                    const name = b.name || 'Sem Nome';
                    const tel = b.tel1 || 'Sem contato';

                    list.innerHTML += `
                    <div style="display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,0.03); margin-bottom:8px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <img src="${img}" style="width:50px; height:50px; border-radius:10px; object-fit:cover; background:#000;">
                        <div style="flex:1;">
                            <div style="font-weight:700; color:#f1f5f9;">${name}</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">${tel}</div>
                        </div>
                        <button class="btn-icon" style="background:rgba(244,63,94,0.2); color:#f43f5e;" onclick="deleteFleet('${b.id}')"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            }

            // 2. Renderizar Usuários (Com verificação de nulidade)
            function renderUsers(u, b) {
                const l = document.getElementById('users-list'); 
                const rl = document.getElementById('ranking-list'); 
                l.innerHTML=""; 
                rl.innerHTML="";

                if(!u) {
                    l.innerHTML = "<tr><td colspan='4' style='text-align:center; color:gray'>Sem usuários.</td></tr>";
                    rl.innerHTML = "Sem dados.";
                    return;
                }

                let sc = [];
                Object.entries(u).forEach(([k,v]) => {
                    let pts = 0;
                    // Calcula pontos com segurança (verifica se 'b' existe)
                    if(b) Object.values(b).forEach(d => {
                        if(d) Object.values(d).forEach(t => { 
                            if(t.registeredBy === v.whatsapp) pts += ((t.likes||0) - (t.dislikes||0)); 
                        });
                    });
                    
                    sc.push({n:v.nome, p:pts});
                    l.innerHTML += `<tr><td><b>${v.nome}</b></td><td>${v.whatsapp}</td><td><span style="color:${pts>=0?'var(--primary)':'var(--danger)'}">${pts} Pts</span></td><td><button class="btn-icon" style="background:rgba(244,63,94,0.2); color:#f43f5e;" onclick="deleteUser('${k}')"><i class="fas fa-user-slash"></i></button></td></tr>`;
                });

                sc.sort((x,y)=>y.p-x.p);
                rl.innerHTML = sc.slice(0,5).map((x,i)=>`<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #ffffff10"><span>${i+1}. ${x.n}</span><span style="color:#22d3ee; font-weight:800">${x.p}</span></div>`).join('');
            }

            // 3. Renderizar Viagens
            function renderTrips(b) {
                const l = document.getElementById('trips-list'); 
                l.innerHTML="";
                
                if(!b) {
                    l.innerHTML = "<tr><td colspan='5' style='text-align:center; color:gray'>Nenhuma viagem ativa.</td></tr>";
                    return;
                }

                Object.keys(b).forEach(day => {
                    if(b[day]) {
                        Object.entries(b[day]).forEach(([k, t]) => {
                            l.innerHTML += `<tr>
                                <td><div style="display:flex; align-items:center; gap:8px;"><img src="${t.img}" style="width:30px; height:30px; border-radius:50%; object-fit:cover"> ${t.name}</div></td>
                                <td>${day}</td>
                                <td>${t.origin} > ${t.destiny}</td>
                                <td><span style="color:var(--success)">+${t.likes||0}</span></td>
                                <td><button class="btn-icon" style="background:rgba(244,63,94,0.2); color:#f43f5e;" onclick="deleteTrip('${day}','${k}')"><i class="fas fa-trash"></i></button></td>
                            </tr>`;
                        });
                    }
                });
            }

            // 4. Renderizar Denuncias
            function renderReports(r) {
                const l = document.getElementById('reports-list'); 
                l.innerHTML="";
                
                if(!r) {
                    l.innerHTML = "<tr><td colspan='4' style='text-align:center; color:gray'>Sem denúncias pendentes.</td></tr>";
                    return;
                }

                Object.entries(r).forEach(([k,v]) => {
                    l.innerHTML += `<tr>
                        <td><b style="color:var(--primary)">${v.boatName || 'Desconhecido'}</b></td>
                        <td>${v.reason}</td>
                        <td>${v.reportedBy}</td>
                        <td><button class="btn btn-primary" style="padding:5px 10px; font-size:0.7rem;" onclick="resolveReport('${k}')">RESOLVER</button></td>
                    </tr>`;
                });
            }

            // 5. Configurações
            function renderConfig(c) {
                if(c && c.alerta) document.getElementById('alert-text-config').value = c.alerta.text;
                const bl = document.getElementById('banner-list'); bl.innerHTML="";
                if(c && c.carrossel) Object.entries(c.carrossel).forEach(([k,v]) => bl.innerHTML+=`<div class="banner-item"><img src="${v.img}" style="width:100%"><button onclick="delBanner('${k}')" style="position:absolute;top:2px;right:2px;background:red;color:white;border:none">X</button></div>`);
            }

            // --- AÇÕES DO ADMIN ---
            window.processFleetImage = function(input) {
                if (input.files && input.files[0]) {
                    const r = new FileReader();
                    r.onload = e => {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const c = document.createElement('canvas'); const s = 500/img.width;
                            c.width = 500; c.height = img.height * s;
                            c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                            fleetImgBase64 = c.toDataURL('image/jpeg', 0.6);
                            document.getElementById('fleet-preview').src = fleetImgBase64;
                            document.getElementById('fleet-preview').style.display = 'block';
                        }
                    }; r.readAsDataURL(input.files[0]);
                }
            }

            window.saveFleetBoat = function() {
                const n = document.getElementById('fleet-name').value;
                const t1 = document.getElementById('fleet-tel1').value;
                const t2 = document.getElementById('fleet-tel2').value;
                if(!n || !t1 || !fleetImgBase64) return alert("Preencha todos os dados");
                const id = Date.now();
                db.ref('barcos_cadastrados/'+id).set({id:id, name:n, tel1:t1, tel2:t2, img:fleetImgBase64}).then(()=>{
                    showToast("Barco Salvo!");
                    document.getElementById('fleet-name').value="";
                    document.getElementById('fleet-preview').style.display='none';
                    fleetImgBase64="";
                });
            }

            window.deleteFleet = function(id) { if(confirm("Apagar?")) db.ref('barcos_cadastrados/'+id).remove(); }
            window.deleteTrip = function(d,k) { if(confirm("Apagar?")) db.ref(`barcos/${d}/${k}`).remove(); }
            window.deleteUser = function(u) { if(confirm("Banir?")) db.ref('usuarios_cadastrados/'+u).remove(); }
            window.resolveReport = function(k) { if(confirm("Resolver?")) db.ref('denuncias/'+k).remove(); }
            
            window.setGlobalAlert = function(a) { db.ref('config/alerta').set({text:document.getElementById('alert-text-config').value, active:a}).then(()=>showToast("Atualizado")); }
            window.addBanner = function() { 
                const u=document.getElementById('banner-url').value, l=document.getElementById('banner-link').value;
                if(u) db.ref('config/carrossel').push({img:u, link:l}).then(()=>showToast("Banner OK"));
            }
            window.delBanner = function(k) { if(confirm("Apagar?")) db.ref('config/carrossel/'+k).remove(); }
        });
    </script>
</body>
</html>
